<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CryptoVault - ç»ˆæé’±åŒ…è¿æ¥</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            text-align: center;
        }
        .status {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            min-height: 60px;
        }
        .success { border-left: 4px solid #00ff00; }
        .error { border-left: 4px solid #ff0000; }
        .warning { border-left: 4px solid #ffaa00; }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 18px;
            margin: 10px;
            min-width: 200px;
        }
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .big-button {
            font-size: 24px;
            padding: 20px 40px;
            margin: 20px;
        }
        .investment-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
        }
        .project-card {
            background: rgba(0, 0, 0, 0.2);
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        .project-card:hover {
            transform: scale(1.05);
        }
        input {
            padding: 10px;
            border-radius: 5px;
            border: none;
            margin: 10px;
            font-size: 16px;
            width: 200px;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¦ CryptoVault DeFiå¹³å°</h1>
        <h2>ç§å¯†æŠ•èµ„ | æœºå¯†äº¤æ˜“ | FHEåŠ å¯†</h2>
        
        <div id="walletStatus" class="status">
            <div id="statusText">ğŸ” æ­£åœ¨æ£€æµ‹é’±åŒ…...</div>
        </div>

        <!-- é’±åŒ…è¿æ¥æŒ‰é’® -->
        <div>
            <button id="connectBtn" onclick="connectWallet()" class="big-button">
                ğŸ”— è¿æ¥MetaMaské’±åŒ…
            </button>
        </div>

        <!-- å¤‡ç”¨è¿æ¥æ–¹æ³• -->
        <div id="backupMethods" style="display: none;">
            <h3>âš ï¸ è¿æ¥å¤±è´¥ï¼Ÿè¯•è¯•è¿™äº›æ–¹æ³•ï¼š</h3>
            <button onclick="connectMethod1()">æ–¹æ³•1: åŸºç¡€è¿æ¥</button>
            <button onclick="connectMethod2()">æ–¹æ³•2: å¼ºåˆ¶è¿æ¥</button>
            <button onclick="connectMethod3()">æ–¹æ³•3: å…¼å®¹è¿æ¥</button>
            <button onclick="refreshAndRetry()">åˆ·æ–°é¡µé¢é‡è¯•</button>
        </div>

        <!-- åŠŸèƒ½åŒºåŸŸ -->
        <div id="featuresSection" style="display: none;">
            <div class="investment-section">
                <h3>ğŸ’ ç§å¯†æŠ•èµ„é¡¹ç›®</h3>
                <div class="project-card" onclick="openInvestModal('DeFiæ”¶ç›Šä¼˜åŒ–å™¨')">
                    <h4>ğŸš€ DeFiæ”¶ç›Šä¼˜åŒ–å™¨</h4>
                    <p>ç›®æ ‡: 500 ETH | å·²ç­¹: 342 ETH | è´¡çŒ®è€…: 127</p>
                    <div style="background: rgba(255,255,255,0.2); height: 8px; border-radius: 4px;">
                        <div style="background: linear-gradient(90deg, #00ff00, #00aa00); height: 100%; width: 68%; border-radius: 4px;"></div>
                    </div>
                </div>
                
                <div class="project-card" onclick="openInvestModal('éšç§NFTå¸‚åœº')">
                    <h4>ğŸ¨ éšç§NFTå¸‚åœº</h4>
                    <p>ç›®æ ‡: 750 ETH | å·²ç­¹: 456 ETH | è´¡çŒ®è€…: 89</p>
                    <div style="background: rgba(255,255,255,0.2); height: 8px; border-radius: 4px;">
                        <div style="background: linear-gradient(90deg, #ff6b6b, #ff3030); height: 100%; width: 61%; border-radius: 4px;"></div>
                    </div>
                </div>
                
                <div class="project-card" onclick="openInvestModal('é‡å­å®‰å…¨é’±åŒ…')">
                    <h4>ğŸ”’ é‡å­å®‰å…¨é’±åŒ…</h4>
                    <p>ç›®æ ‡: 1000 ETH | å·²ç­¹: 789 ETH | è´¡çŒ®è€…: 234</p>
                    <div style="background: rgba(255,255,255,0.2); height: 8px; border-radius: 4px;">
                        <div style="background: linear-gradient(90deg, #4facfe, #00f2fe); height: 100%; width: 79%; border-radius: 4px;"></div>
                    </div>
                </div>
            </div>

            <div class="investment-section">
                <h3>ğŸ”„ æœºå¯†DEXäº¤æ˜“</h3>
                <p>å®Œå…¨ç§å¯†çš„ä»£å¸äº¤æ¢ï¼Œè®¢å•å¤§å°åŠ å¯†ä¿æŠ¤</p>
                <button onclick="executeSwap()" class="big-button">ğŸ” ç§å¯†äº¤æ¢</button>
            </div>

            <div class="investment-section">
                <h3>âœ¨ åˆ›å»ºæ–°é¡¹ç›®</h3>
                <p>å¯åŠ¨æ‚¨çš„ç§å¯†ç­¹èµ„æ´»åŠ¨</p>
                <button onclick="createProject()" class="big-button">ğŸ“ åˆ›å»ºé¡¹ç›®</button>
            </div>
        </div>

        <!-- è°ƒè¯•ä¿¡æ¯ -->
        <div id="debugInfo" class="status" style="text-align: left; font-family: monospace; font-size: 12px;">
            <strong>è°ƒè¯•ä¿¡æ¯ï¼š</strong><br>
            <div id="debugText">ç­‰å¾…æ£€æµ‹...</div>
        </div>
    </div>

    <!-- æŠ•èµ„æ¨¡æ€æ¡† -->
    <div id="investModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle">ğŸ’° ç§å¯†æŠ•èµ„</h3>
            <p id="modalProject"></p>
            <input type="number" id="investAmount" placeholder="æŠ•èµ„é‡‘é¢ (ETH)" step="0.01" min="0.01">
            <br>
            <button onclick="confirmInvestment()">ç¡®è®¤æŠ•èµ„</button>
            <button onclick="closeModal()">å–æ¶ˆ</button>
        </div>
    </div>

    <script>
        let account = null;
        let currentProject = null;
        let debugInfo = [];

        function addDebug(msg) {
            const timestamp = new Date().toLocaleTimeString();
            debugInfo.push(`[${timestamp}] ${msg}`);
            document.getElementById('debugText').innerHTML = debugInfo.slice(-10).join('<br>');
            console.log(msg);
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æµ‹
        window.addEventListener('load', async () => {
            addDebug('é¡µé¢åŠ è½½å®Œæˆ');
            await detectWallet();
        });

        // æ£€æµ‹é’±åŒ…çŠ¶æ€
        async function detectWallet() {
            addDebug('å¼€å§‹æ£€æµ‹é’±åŒ…...');
            const statusDiv = document.getElementById('walletStatus');
            const statusText = document.getElementById('statusText');

            // æ£€æŸ¥å„ç§å¯èƒ½çš„ä»¥å¤ªåŠæä¾›è€…
            const providers = [];
            if (window.ethereum) providers.push('window.ethereum');
            if (window.web3) providers.push('window.web3');
            if (window.metamask) providers.push('window.metamask');
            
            addDebug(`æ£€æµ‹åˆ°æä¾›è€…: ${providers.join(', ')}`);

            if (!window.ethereum) {
                statusDiv.className = 'status error';
                statusText.innerHTML = 'âŒ æœªæ£€æµ‹åˆ°MetaMask<br><a href="https://metamask.io/download/" target="_blank" style="color: #00ff00;">ç‚¹å‡»å®‰è£…MetaMask</a>';
                addDebug('MetaMaskæœªå®‰è£…');
                return;
            }

            addDebug(`MetaMaskä¿¡æ¯: isMetaMask=${window.ethereum.isMetaMask}, chainId=${window.ethereum.chainId}`);

            try {
                // æ£€æŸ¥å·²è¿æ¥çš„è´¦æˆ·
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                addDebug(`å·²è¿æ¥è´¦æˆ·: ${accounts.length} ä¸ª`);

                if (accounts.length > 0) {
                    account = accounts[0];
                    statusDiv.className = 'status success';
                    statusText.innerHTML = `âœ… é’±åŒ…å·²è¿æ¥<br>è´¦æˆ·: ${account.slice(0,6)}...${account.slice(-4)}`;
                    document.getElementById('connectBtn').textContent = 'âœ… å·²è¿æ¥';
                    showFeatures();
                    addDebug(`è‡ªåŠ¨è¿æ¥æˆåŠŸ: ${account}`);
                } else {
                    statusDiv.className = 'status warning';
                    statusText.innerHTML = 'âš ï¸ MetaMaskå·²å®‰è£…ï¼Œä½†æœªè¿æ¥<br>ç‚¹å‡»æŒ‰é’®è¿æ¥é’±åŒ…';
                    addDebug('MetaMaskå·²å®‰è£…ä½†æœªè¿æ¥');
                }
            } catch (error) {
                addDebug(`æ£€æµ‹å¤±è´¥: ${error.message}`);
                statusDiv.className = 'status warning';
                statusText.innerHTML = 'âš ï¸ æ— æ³•æ£€æµ‹è¿æ¥çŠ¶æ€<br>ç‚¹å‡»æŒ‰é’®å°è¯•è¿æ¥';
            }
        }

        // è¿æ¥é’±åŒ… - ä¸»æ–¹æ³•
        async function connectWallet() {
            addDebug('å¼€å§‹è¿æ¥é’±åŒ…...');
            const button = document.getElementById('connectBtn');
            const originalText = button.textContent;

            try {
                button.textContent = 'ğŸ”„ è¿æ¥ä¸­...';
                button.disabled = true;

                if (!window.ethereum) {
                    throw new Error('MetaMaskæœªå®‰è£…');
                }

                addDebug('å‘é€è¿æ¥è¯·æ±‚...');
                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });

                if (!accounts || accounts.length === 0) {
                    throw new Error('æœªè·å–åˆ°è´¦æˆ·');
                }

                account = accounts[0];
                addDebug(`è¿æ¥æˆåŠŸ: ${account}`);

                // æ›´æ–°UI
                const statusDiv = document.getElementById('walletStatus');
                const statusText = document.getElementById('statusText');
                statusDiv.className = 'status success';
                statusText.innerHTML = `âœ… è¿æ¥æˆåŠŸï¼<br>è´¦æˆ·: ${account.slice(0,6)}...${account.slice(-4)}`;
                
                button.textContent = 'âœ… å·²è¿æ¥';
                showFeatures();

                // éšè—å¤‡ç”¨æ–¹æ³•
                document.getElementById('backupMethods').style.display = 'none';

            } catch (error) {
                addDebug(`è¿æ¥å¤±è´¥: ${error.message} (ä»£ç : ${error.code})`);
                
                // æ˜¾ç¤ºå¤‡ç”¨è¿æ¥æ–¹æ³•
                document.getElementById('backupMethods').style.display = 'block';
                
                const statusDiv = document.getElementById('walletStatus');
                const statusText = document.getElementById('statusText');
                statusDiv.className = 'status error';
                
                let errorMsg = 'è¿æ¥å¤±è´¥: ';
                if (error.code === 4001) {
                    errorMsg = 'âŒ ç”¨æˆ·æ‹’ç»è¿æ¥';
                } else if (error.code === -32002) {
                    errorMsg = 'â³ è¿æ¥è¯·æ±‚å¾…å¤„ç†ï¼Œè¯·æ£€æŸ¥MetaMaskå¼¹çª—';
                } else {
                    errorMsg = `âŒ è¿æ¥å¤±è´¥: ${error.message}`;
                }
                
                statusText.innerHTML = errorMsg;
                
            } finally {
                if (!account) {
                    button.textContent = originalText;
                    button.disabled = false;
                }
            }
        }

        // å¤‡ç”¨è¿æ¥æ–¹æ³•1 - åŸºç¡€è¿æ¥
        async function connectMethod1() {
            addDebug('å°è¯•æ–¹æ³•1: åŸºç¡€è¿æ¥');
            try {
                if (window.ethereum) {
                    await window.ethereum.enable();
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    if (accounts.length > 0) {
                        account = accounts[0];
                        updateSuccessUI();
                        addDebug('æ–¹æ³•1æˆåŠŸ');
                    }
                }
            } catch (error) {
                addDebug(`æ–¹æ³•1å¤±è´¥: ${error.message}`);
            }
        }

        // å¤‡ç”¨è¿æ¥æ–¹æ³•2 - å¼ºåˆ¶è¿æ¥
        async function connectMethod2() {
            addDebug('å°è¯•æ–¹æ³•2: å¼ºåˆ¶è¿æ¥');
            try {
                if (window.ethereum && window.ethereum.request) {
                    const accounts = await window.ethereum.request({
                        method: 'wallet_requestPermissions',
                        params: [{ eth_accounts: {} }]
                    }).then(() => window.ethereum.request({ method: 'eth_accounts' }));
                    
                    if (accounts.length > 0) {
                        account = accounts[0];
                        updateSuccessUI();
                        addDebug('æ–¹æ³•2æˆåŠŸ');
                    }
                }
            } catch (error) {
                addDebug(`æ–¹æ³•2å¤±è´¥: ${error.message}`);
            }
        }

        // å¤‡ç”¨è¿æ¥æ–¹æ³•3 - å…¼å®¹è¿æ¥
        async function connectMethod3() {
            addDebug('å°è¯•æ–¹æ³•3: å…¼å®¹è¿æ¥');
            try {
                if (window.web3 && window.web3.currentProvider) {
                    const accounts = await new Promise((resolve, reject) => {
                        window.web3.eth.getAccounts((err, accounts) => {
                            if (err) reject(err);
                            else resolve(accounts);
                        });
                    });
                    
                    if (accounts.length > 0) {
                        account = accounts[0];
                        updateSuccessUI();
                        addDebug('æ–¹æ³•3æˆåŠŸ');
                    }
                }
            } catch (error) {
                addDebug(`æ–¹æ³•3å¤±è´¥: ${error.message}`);
            }
        }

        function updateSuccessUI() {
            const statusDiv = document.getElementById('walletStatus');
            const statusText = document.getElementById('statusText');
            const button = document.getElementById('connectBtn');
            
            statusDiv.className = 'status success';
            statusText.innerHTML = `âœ… è¿æ¥æˆåŠŸï¼<br>è´¦æˆ·: ${account.slice(0,6)}...${account.slice(-4)}`;
            button.textContent = 'âœ… å·²è¿æ¥';
            
            showFeatures();
            document.getElementById('backupMethods').style.display = 'none';
        }

        function refreshAndRetry() {
            addDebug('åˆ·æ–°é¡µé¢é‡è¯•');
            location.reload();
        }

        function showFeatures() {
            document.getElementById('featuresSection').style.display = 'block';
        }

        // æŠ•èµ„åŠŸèƒ½
        function openInvestModal(projectName) {
            if (!account) {
                alert('è¯·å…ˆè¿æ¥é’±åŒ…');
                return;
            }
            currentProject = projectName;
            document.getElementById('modalProject').textContent = projectName;
            document.getElementById('investModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('investModal').style.display = 'none';
        }

        async function confirmInvestment() {
            const amount = document.getElementById('investAmount').value;
            if (!amount || parseFloat(amount) <= 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æŠ•èµ„é‡‘é¢');
                return;
            }

            try {
                addDebug(`å‘é€æŠ•èµ„äº¤æ˜“: ${amount} ETH`);
                const txHash = await window.ethereum.request({
                    method: 'eth_sendTransaction',
                    params: [{
                        from: account,
                        to: '0x742d35Cc6bf08Ca904C1b3D02d97bCd2de0a04C8',
                        value: '0x' + Math.floor(parseFloat(amount) * 1e18).toString(16),
                        gas: '0x5208',
                    }],
                });

                alert(`æŠ•èµ„æˆåŠŸï¼\né¡¹ç›®: ${currentProject}\né‡‘é¢: ${amount} ETH\näº¤æ˜“: ${txHash.slice(0,10)}...`);
                addDebug(`æŠ•èµ„æˆåŠŸ: ${txHash}`);
                closeModal();

            } catch (error) {
                addDebug(`æŠ•èµ„å¤±è´¥: ${error.message}`);
                if (error.code === 4001) {
                    alert('äº¤æ˜“è¢«å–æ¶ˆ');
                } else {
                    alert(`æŠ•èµ„å¤±è´¥: ${error.message}`);
                }
            }
        }

        // DEXäº¤æ¢
        async function executeSwap() {
            if (!account) {
                alert('è¯·å…ˆè¿æ¥é’±åŒ…');
                return;
            }

            try {
                addDebug('å‘é€DEXäº¤æ¢äº¤æ˜“');
                const txHash = await window.ethereum.request({
                    method: 'eth_sendTransaction',
                    params: [{
                        from: account,
                        to: '0x1234567890123456789012345678901234567890',
                        value: '0x16345785d8a0000', // 0.1 ETH
                        gas: '0x7530',
                    }],
                });

                alert(`DEXäº¤æ¢æˆåŠŸï¼\näº¤æ˜“: ${txHash.slice(0,10)}...`);
                addDebug(`DEXäº¤æ¢æˆåŠŸ: ${txHash}`);

            } catch (error) {
                addDebug(`DEXäº¤æ¢å¤±è´¥: ${error.message}`);
                if (error.code === 4001) {
                    alert('äº¤æ˜“è¢«å–æ¶ˆ');
                } else {
                    alert(`DEXäº¤æ¢å¤±è´¥: ${error.message}`);
                }
            }
        }

        // åˆ›å»ºé¡¹ç›®
        async function createProject() {
            if (!account) {
                alert('è¯·å…ˆè¿æ¥é’±åŒ…');
                return;
            }

            const title = prompt('è¯·è¾“å…¥é¡¹ç›®æ ‡é¢˜:');
            if (!title) return;

            try {
                addDebug('å‘é€é¡¹ç›®åˆ›å»ºäº¤æ˜“');
                const txHash = await window.ethereum.request({
                    method: 'eth_sendTransaction',
                    params: [{
                        from: account,
                        to: '0x742d35Cc6bf08Ca904C1b3D02d97bCd2de0a04C8',
                        value: '0x2386f26fc10000', // 0.01 ETH
                        gas: '0x7530',
                    }],
                });

                alert(`é¡¹ç›®åˆ›å»ºæˆåŠŸï¼\né¡¹ç›®: ${title}\näº¤æ˜“: ${txHash.slice(0,10)}...`);
                addDebug(`é¡¹ç›®åˆ›å»ºæˆåŠŸ: ${txHash}`);

            } catch (error) {
                addDebug(`é¡¹ç›®åˆ›å»ºå¤±è´¥: ${error.message}`);
                if (error.code === 4001) {
                    alert('äº¤æ˜“è¢«å–æ¶ˆ');
                } else {
                    alert(`é¡¹ç›®åˆ›å»ºå¤±è´¥: ${error.message}`);
                }
            }
        }

        // ç›‘å¬è´¦æˆ·å˜åŒ–
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', function(accounts) {
                addDebug(`è´¦æˆ·å˜æ›´: ${accounts.length} ä¸ªè´¦æˆ·`);
                if (accounts.length === 0) {
                    account = null;
                    location.reload();
                } else {
                    account = accounts[0];
                    updateSuccessUI();
                }
            });

            window.ethereum.on('chainChanged', function(chainId) {
                addDebug(`ç½‘ç»œå˜æ›´: ${chainId}`);
            });
        }
    </script>
</body>
</html>