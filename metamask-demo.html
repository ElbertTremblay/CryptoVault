<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CryptoVault - MetaMaské›†æˆæµ‹è¯•</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            max-width: 400px;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="min-h-screen flex items-center justify-center p-4">
        <div class="glass-effect p-8 max-w-md w-full text-center">
            <h1 class="text-3xl font-bold text-white mb-6">CryptoVault MetaMask æµ‹è¯•</h1>
            
            <!-- é’±åŒ…çŠ¶æ€ -->
            <div class="mb-6 p-4 glass-effect rounded-lg">
                <h3 class="text-white font-semibold mb-2">é’±åŒ…çŠ¶æ€</h3>
                <div id="walletStatus" class="text-white/80 text-sm">æœªè¿æ¥</div>
                <div id="walletAddress" class="text-white/60 text-xs mt-1"></div>
                <div id="walletBalance" class="text-white/60 text-xs mt-1"></div>
                <div id="networkInfo" class="text-white/60 text-xs mt-1"></div>
            </div>
            
            <!-- è¿æ¥æŒ‰é’® -->
            <button id="connectBtn" onclick="connectWallet()" class="btn-primary w-full mb-4">
                è¿æ¥ MetaMask
            </button>
            
            <!-- æµ‹è¯•æŒ‰é’® -->
            <div class="space-y-3">
                <button id="testInvestBtn" onclick="testInvestment()" class="btn-secondary w-full" disabled>
                    æµ‹è¯•æŠ•èµ„äº¤æ˜“ (0.001 ETH)
                </button>
                
                <button id="testSwapBtn" onclick="testSwap()" class="btn-secondary w-full" disabled>
                    æµ‹è¯•äº¤æ¢äº¤æ˜“ (0.001 ETH)
                </button>
                
                <button onclick="checkEthereum()" class="btn-primary w-full">
                    æ£€æŸ¥ Ethereum å¯¹è±¡
                </button>
            </div>
            
            <!-- æ—¥å¿—åŒºåŸŸ -->
            <div class="mt-6 p-4 glass-effect rounded-lg">
                <h3 class="text-white font-semibold mb-2">è°ƒè¯•æ—¥å¿—</h3>
                <div id="debugLog" class="text-white/70 text-xs text-left max-h-40 overflow-y-auto">
                    ç­‰å¾…æ“ä½œ...
                </div>
                <button onclick="clearLog()" class="text-white/50 text-xs mt-2">æ¸…ç©ºæ—¥å¿—</button>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let provider = null;
        let signer = null;
        let userAddress = '';
        let isConnected = false;

        // æ—¥å¿—å‡½æ•°
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('debugLog');
            logDiv.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function clearLog() {
            document.getElementById('debugLog').innerHTML = 'æ—¥å¿—å·²æ¸…ç©º<br>';
        }

        // é€šçŸ¥å‡½æ•°
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : 
                           type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            
            notification.className = `notification ${bgColor} text-white p-4 rounded-lg shadow-lg`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // æ£€æŸ¥ Ethereum å¯¹è±¡
        function checkEthereum() {
            log('å¼€å§‹æ£€æŸ¥ Ethereum å¯¹è±¡...');
            
            if (typeof window.ethereum === 'undefined') {
                log('âŒ window.ethereum ä¸å­˜åœ¨ - MetaMask æœªå®‰è£…');
                showNotification('MetaMask æœªæ£€æµ‹åˆ°ï¼Œè¯·å®‰è£… MetaMask æµè§ˆå™¨æ‰©å±•', 'error');
                return false;
            }
            
            log('âœ… window.ethereum å­˜åœ¨');
            log(`Ethereum ç‰ˆæœ¬: ${window.ethereum.networkVersion || 'unknown'}`);
            log(`æ˜¯å¦ä¸º MetaMask: ${window.ethereum.isMetaMask ? 'Yes' : 'No'}`);
            log(`è¿æ¥çŠ¶æ€: ${window.ethereum.isConnected() ? 'Connected' : 'Disconnected'}`);
            
            if (window.ethereum.selectedAddress) {
                log(`å½“å‰åœ°å€: ${window.ethereum.selectedAddress}`);
            }
            
            return true;
        }

        // æ›´æ–°UIçŠ¶æ€
        function updateUI() {
            const connectBtn = document.getElementById('connectBtn');
            const testInvestBtn = document.getElementById('testInvestBtn');
            const testSwapBtn = document.getElementById('testSwapBtn');
            const statusDiv = document.getElementById('walletStatus');
            const addressDiv = document.getElementById('walletAddress');
            const balanceDiv = document.getElementById('walletBalance');
            const networkDiv = document.getElementById('networkInfo');
            
            if (isConnected && userAddress) {
                connectBtn.textContent = 'æ–­å¼€è¿æ¥';
                testInvestBtn.disabled = false;
                testSwapBtn.disabled = false;
                statusDiv.textContent = 'å·²è¿æ¥';
                addressDiv.textContent = `åœ°å€: ${userAddress.substring(0, 6)}...${userAddress.substring(userAddress.length - 4)}`;
                
                // è·å–ä½™é¢
                if (provider) {
                    provider.getBalance(userAddress).then(balance => {
                        const ethBalance = (parseFloat(balance) / 1e18).toFixed(4);
                        balanceDiv.textContent = `ä½™é¢: ${ethBalance} ETH`;
                    });
                    
                    // è·å–ç½‘ç»œä¿¡æ¯
                    provider.getNetwork().then(network => {
                        networkDiv.textContent = `ç½‘ç»œ: ${network.name} (Chain ID: ${network.chainId})`;
                    });
                }
            } else {
                connectBtn.textContent = 'è¿æ¥ MetaMask';
                testInvestBtn.disabled = true;
                testSwapBtn.disabled = true;
                statusDiv.textContent = 'æœªè¿æ¥';
                addressDiv.textContent = '';
                balanceDiv.textContent = '';
                networkDiv.textContent = '';
            }
        }

        // è¿æ¥é’±åŒ…å‡½æ•°
        async function connectWallet() {
            log('å¼€å§‹è¿æ¥é’±åŒ…æµç¨‹...');
            
            if (isConnected) {
                // æ–­å¼€è¿æ¥
                log('æ–­å¼€é’±åŒ…è¿æ¥');
                isConnected = false;
                provider = null;
                signer = null;
                userAddress = '';
                updateUI();
                showNotification('é’±åŒ…å·²æ–­å¼€è¿æ¥', 'info');
                return;
            }
            
            // æ£€æŸ¥ MetaMask
            if (!checkEthereum()) {
                return;
            }
            
            try {
                log('è¯·æ±‚è´¦æˆ·è®¿é—®æƒé™...');
                
                // è¯·æ±‚è¿æ¥
                const accounts = await window.ethereum.request({ 
                    method: 'eth_requestAccounts' 
                });
                
                log(`è·åˆ°è´¦æˆ·: ${accounts.length} ä¸ª`);
                log(`ä¸»è´¦æˆ·: ${accounts[0]}`);
                
                if (accounts.length === 0) {
                    throw new Error('æ²¡æœ‰æ‰¾åˆ°è´¦æˆ·');
                }
                
                // åˆå§‹åŒ– provider å’Œ signer
                log('åˆå§‹åŒ– Ethers.js provider...');
                provider = new ethers.BrowserProvider(window.ethereum);
                
                log('è·å– signer...');
                signer = await provider.getSigner();
                userAddress = await signer.getAddress();
                
                log(`Signer åœ°å€: ${userAddress}`);
                
                isConnected = true;
                updateUI();
                
                log('âœ… é’±åŒ…è¿æ¥æˆåŠŸï¼');
                showNotification('MetaMask è¿æ¥æˆåŠŸï¼', 'success');
                
                // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
                window.ethereum.on('accountsChanged', handleAccountsChanged);
                window.ethereum.on('chainChanged', handleChainChanged);
                window.ethereum.on('disconnect', handleDisconnect);
                
            } catch (error) {
                log(`âŒ è¿æ¥å¤±è´¥: ${error.message}`);
                console.error('è¿æ¥é’±åŒ…å¤±è´¥:', error);
                showNotification(`è¿æ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•æŠ•èµ„äº¤æ˜“
        async function testInvestment() {
            if (!isConnected || !signer) {
                showNotification('è¯·å…ˆè¿æ¥é’±åŒ…', 'error');
                return;
            }
            
            try {
                log('å‡†å¤‡å‘é€æŠ•èµ„äº¤æ˜“...');
                showNotification('è¯·åœ¨ MetaMask ä¸­ç¡®è®¤æŠ•èµ„äº¤æ˜“...', 'info');
                
                const transaction = {
                    to: '0x742d35Cc6635C0532925a3b8D06080f0Ec0BAff5', // æµ‹è¯•åœ°å€
                    value: ethers.parseEther('0.001'), // 0.001 ETH
                    gasLimit: 21000
                };
                
                log(`äº¤æ˜“è¯¦æƒ…: to=${transaction.to}, value=${ethers.formatEther(transaction.value)} ETH`);
                
                // å‘é€äº¤æ˜“
                log('è°ƒç”¨ signer.sendTransaction()...');
                const txResponse = await signer.sendTransaction(transaction);
                
                log(`âœ… äº¤æ˜“å·²å‘é€! Hash: ${txResponse.hash}`);
                showNotification(`äº¤æ˜“å·²æäº¤ï¼Hash: ${txResponse.hash.substring(0, 10)}...`, 'info');
                
                log('ç­‰å¾…äº¤æ˜“ç¡®è®¤...');
                const receipt = await txResponse.wait();
                
                if (receipt.status === 1) {
                    log('âœ… äº¤æ˜“ç¡®è®¤æˆåŠŸï¼');
                    showNotification('ğŸ‰ æŠ•èµ„äº¤æ˜“æˆåŠŸç¡®è®¤ï¼', 'success');
                } else {
                    log('âŒ äº¤æ˜“å¤±è´¥');
                    showNotification('äº¤æ˜“å¤±è´¥', 'error');
                }
                
                updateUI(); // æ›´æ–°ä½™é¢
                
            } catch (error) {
                log(`âŒ æŠ•èµ„äº¤æ˜“å¤±è´¥: ${error.message}`);
                console.error('æŠ•èµ„äº¤æ˜“å¤±è´¥:', error);
                
                let errorMessage = 'æŠ•èµ„äº¤æ˜“å¤±è´¥';
                if (error.code === 4001) {
                    errorMessage = 'ç”¨æˆ·å–æ¶ˆäº†äº¤æ˜“';
                } else if (error.code === -32603) {
                    errorMessage = 'äº¤æ˜“è¢«æ‹’ç»';
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                showNotification(errorMessage, 'error');
            }
        }

        // æµ‹è¯•äº¤æ¢äº¤æ˜“
        async function testSwap() {
            if (!isConnected || !signer) {
                showNotification('è¯·å…ˆè¿æ¥é’±åŒ…', 'error');
                return;
            }
            
            try {
                log('å‡†å¤‡å‘é€äº¤æ¢äº¤æ˜“...');
                showNotification('è¯·åœ¨ MetaMask ä¸­ç¡®è®¤äº¤æ¢äº¤æ˜“...', 'info');
                
                const transaction = {
                    to: '0x1f9840a85d5aF5bf1D1762F925BDADdC4201F984', // UNI ä»£å¸åœ°å€
                    value: ethers.parseEther('0.001'),
                    gasLimit: 50000
                };
                
                log(`äº¤æ˜“è¯¦æƒ…: to=${transaction.to}, value=${ethers.formatEther(transaction.value)} ETH`);
                
                const txResponse = await signer.sendTransaction(transaction);
                
                log(`âœ… äº¤æ˜“å·²å‘é€! Hash: ${txResponse.hash}`);
                showNotification(`äº¤æ˜“å·²æäº¤ï¼Hash: ${txResponse.hash.substring(0, 10)}...`, 'info');
                
                const receipt = await txResponse.wait();
                
                if (receipt.status === 1) {
                    log('âœ… äº¤æ˜“ç¡®è®¤æˆåŠŸï¼');
                    showNotification('ğŸ‰ äº¤æ¢äº¤æ˜“æˆåŠŸç¡®è®¤ï¼', 'success');
                } else {
                    log('âŒ äº¤æ˜“å¤±è´¥');
                    showNotification('äº¤æ˜“å¤±è´¥', 'error');
                }
                
                updateUI();
                
            } catch (error) {
                log(`âŒ äº¤æ¢äº¤æ˜“å¤±è´¥: ${error.message}`);
                console.error('äº¤æ¢äº¤æ˜“å¤±è´¥:', error);
                
                let errorMessage = 'äº¤æ¢äº¤æ˜“å¤±è´¥';
                if (error.code === 4001) {
                    errorMessage = 'ç”¨æˆ·å–æ¶ˆäº†äº¤æ˜“';
                }
                
                showNotification(errorMessage, 'error');
            }
        }

        // äº‹ä»¶å¤„ç†å™¨
        function handleAccountsChanged(accounts) {
            log(`è´¦æˆ·å˜æ›´: ${accounts.length} ä¸ªè´¦æˆ·`);
            if (accounts.length === 0) {
                isConnected = false;
                provider = null;
                signer = null;
                userAddress = '';
                showNotification('è´¦æˆ·å·²æ–­å¼€', 'info');
            } else {
                log('é‡æ–°è¿æ¥æ–°è´¦æˆ·...');
                connectWallet();
            }
            updateUI();
        }

        function handleChainChanged(chainId) {
            log(`ç½‘ç»œå˜æ›´: Chain ID ${chainId}`);
            showNotification(`ç½‘ç»œå·²åˆ‡æ¢åˆ° Chain ID: ${chainId}`, 'info');
            // é‡æ–°åŠ è½½é¡µé¢æˆ–é‡æ–°è¿æ¥
            window.location.reload();
        }

        function handleDisconnect(error) {
            log(`è¿æ¥æ–­å¼€: ${error ? error.message : 'æœªçŸ¥åŸå› '}`);
            isConnected = false;
            provider = null;
            signer = null;
            userAddress = '';
            updateUI();
            showNotification('MetaMask è¿æ¥å·²æ–­å¼€', 'info');
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', async () => {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œåˆå§‹åŒ–...');
            
            // æ£€æŸ¥æ˜¯å¦å·²ç»è¿æ¥
            if (window.ethereum && window.ethereum.selectedAddress) {
                log(`æ£€æµ‹åˆ°å·²è¿æ¥åœ°å€: ${window.ethereum.selectedAddress}`);
                // è‡ªåŠ¨é‡è¿
                try {
                    provider = new ethers.BrowserProvider(window.ethereum);
                    signer = await provider.getSigner();
                    userAddress = await signer.getAddress();
                    isConnected = true;
                    log('è‡ªåŠ¨é‡è¿æˆåŠŸ');
                } catch (error) {
                    log(`è‡ªåŠ¨é‡è¿å¤±è´¥: ${error.message}`);
                }
            }
            
            updateUI();
            log('åˆå§‹åŒ–å®Œæˆ');
        });
        
        // åŠ¨æ€åŠ è½½ Ethers.js
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/ethers@6.7.0/dist/ethers.umd.min.js';
        script.onload = () => {
            log('Ethers.js åº“åŠ è½½å®Œæˆ');
        };
        script.onerror = () => {
            log('âŒ Ethers.js åº“åŠ è½½å¤±è´¥');
            showNotification('Ethers.js åº“åŠ è½½å¤±è´¥', 'error');
        };
        document.head.appendChild(script);
    </script>
</body>
</html>