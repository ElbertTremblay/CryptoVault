<!DOCTYPE html>
<html>
<head>
    <title>å¼ºåˆ¶æ¸…ç†MetaMaskçŠ¶æ€</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f0f0f0; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; }
        button { background: #007bff; color: white; border: none; padding: 15px 25px; margin: 10px; border-radius: 5px; cursor: pointer; font-size: 16px; }
        button:hover { background: #0056b3; }
        .log { background: #000; color: #00ff00; padding: 15px; border-radius: 5px; font-family: monospace; margin: 15px 0; max-height: 300px; overflow-y: auto; }
        .alert { background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 5px; margin: 15px 0; }
        .success { color: #155724; background: #d4edda; border-color: #c3e6cb; }
        .error { color: #721c24; background: #f8d7da; border-color: #f5c6cb; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ MetaMask çŠ¶æ€å¼ºåˆ¶æ¸…ç†å·¥å…·</h1>
        
        <div class="alert">
            <strong>âš ï¸ å½“å‰é—®é¢˜ï¼š</strong> MetaMask æœ‰å¾…å¤„ç†çš„æƒé™è¯·æ±‚<br>
            <strong>ğŸ“ ä½ç½®ï¼š</strong> http://localhost:3023<br>
            <strong>ğŸ”„ çŠ¶æ€ï¼š</strong> Request of type 'wallet_requestPermissions' already pending
        </div>
        
        <div>
            <h3>ğŸ› ï¸ è‡ªåŠ¨è§£å†³å·¥å…·ï¼š</h3>
            <button onclick="forceReload()">ğŸ”„ å¼ºåˆ¶åˆ·æ–°é¡µé¢</button>
            <button onclick="clearStorage()">ğŸ§¹ æ¸…ç†æœ¬åœ°å­˜å‚¨</button>
            <button onclick="newTabTest()">ğŸ†• æ–°æ ‡ç­¾é¡µæµ‹è¯•</button>
        </div>
        
        <div>
            <h3>ğŸ”Œ è¿æ¥æµ‹è¯•ï¼š</h3>
            <button onclick="testConnection()">ğŸ”— æµ‹è¯•è¿æ¥</button>
            <button onclick="testTransaction()">ğŸ’° æµ‹è¯•äº¤æ˜“</button>
        </div>
        
        <div class="alert">
            <strong>ğŸ“‹ æ‰‹åŠ¨è§£å†³æ­¥éª¤ï¼š</strong><br>
            1. ç‚¹å‡»æµè§ˆå™¨å³ä¸Šè§’ MetaMask å›¾æ ‡<br>
            2. å¦‚æœçœ‹åˆ°è¿æ¥è¯·æ±‚ï¼Œç‚¹å‡»"å–æ¶ˆ"æˆ–"æ‹’ç»"<br>
            3. å…³é—­æ‰€æœ‰ MetaMask å¼¹çª—<br>
            4. ç‚¹å‡»ä¸‹é¢çš„"æµ‹è¯•è¿æ¥"æŒ‰é’®
        </div>
        
        <div class="log" id="log">ç­‰å¾…æ“ä½œ...</div>
    </div>

    <script>
        let account = null;
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('log');
            const color = type === 'error' ? '#ff4444' : 
                         type === 'success' ? '#44ff44' : 
                         type === 'warning' ? '#ffaa44' : '#00ff00';
            logDiv.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        // å¼ºåˆ¶åˆ·æ–°é¡µé¢
        function forceReload() {
            log('ğŸ”„ å¼ºåˆ¶åˆ·æ–°é¡µé¢ï¼Œæ¸…ç†æ‰€æœ‰çŠ¶æ€...', 'warning');
            setTimeout(() => {
                window.location.href = window.location.href + '?t=' + Date.now();
            }, 1000);
        }
        
        // æ¸…ç†æœ¬åœ°å­˜å‚¨
        function clearStorage() {
            log('ğŸ§¹ æ¸…ç†æœ¬åœ°å­˜å‚¨...', 'warning');
            try {
                localStorage.clear();
                sessionStorage.clear();
                log('âœ… æœ¬åœ°å­˜å‚¨å·²æ¸…ç†');
            } catch (error) {
                log(`âŒ æ¸…ç†å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // æ–°æ ‡ç­¾é¡µæµ‹è¯•
        function newTabTest() {
            log('ğŸ†• åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€æµ‹è¯•é¡µé¢...', 'info');
            const newWindow = window.open('about:blank', '_blank');
            newWindow.document.write(\`
                <!DOCTYPE html>
                <html>
                <head><title>æ–°çª—å£MetaMaskæµ‹è¯•</title></head>
                <body>
                    <h1>æ–°çª—å£ MetaMask æµ‹è¯•</h1>
                    <button onclick="connect()">è¿æ¥ MetaMask</button>
                    <div id="result" style="margin: 20px; padding: 15px; background: #f0f0f0;"></div>
                    
                    <script>
                        async function connect() {
                            const result = document.getElementById('result');
                            result.innerHTML = 'æ­£åœ¨è¿æ¥...';
                            
                            if (!window.ethereum) {
                                result.innerHTML = 'âŒ MetaMask æœªå®‰è£…';
                                return;
                            }
                            
                            try {
                                const accounts = await window.ethereum.request({ 
                                    method: 'eth_requestAccounts' 
                                });
                                result.innerHTML = \\\`âœ… è¿æ¥æˆåŠŸï¼<br>è´¦æˆ·: \\\${accounts[0]}\\\`;
                            } catch (error) {
                                result.innerHTML = \\\`âŒ è¿æ¥å¤±è´¥: \\\${error.message}\\\`;
                            }
                        }
                    </script>
                </body>
                </html>
            \`);
        }
        
        // æµ‹è¯•è¿æ¥
        async function testConnection() {
            log('=== å¼€å§‹è¿æ¥æµ‹è¯• ===', 'info');
            
            if (!window.ethereum) {
                log('âŒ MetaMask æœªæ£€æµ‹åˆ°', 'error');
                return;
            }
            
            try {
                // å…ˆæ£€æŸ¥ç°æœ‰è´¦æˆ·
                log('ğŸ” æ£€æŸ¥ç°æœ‰è¿æ¥...', 'info');
                const existingAccounts = await window.ethereum.request({ 
                    method: 'eth_accounts' 
                });
                
                if (existingAccounts.length > 0) {
                    log(\`âœ… å‘ç°å·²è¿æ¥è´¦æˆ·: \${existingAccounts[0]}\`, 'success');
                    account = existingAccounts[0];
                    return;
                }
                
                // è¯·æ±‚æ–°è¿æ¥
                log('ğŸ”„ è¯·æ±‚æ–°è¿æ¥... (è¯·æŸ¥çœ‹MetaMaskå¼¹çª—)', 'info');
                log('ğŸ’¡ æç¤º: è¯·ç‚¹å‡»æµè§ˆå™¨å³ä¸Šè§’çš„MetaMaskå›¾æ ‡æŸ¥çœ‹è¯·æ±‚', 'warning');
                
                const accounts = await window.ethereum.request({ 
                    method: 'eth_requestAccounts' 
                });
                
                if (accounts && accounts.length > 0) {
                    log(\`ğŸ‰ è¿æ¥æˆåŠŸ! è´¦æˆ·: \${accounts[0]}\`, 'success');
                    account = accounts[0];
                } else {
                    log('âŒ æœªè·å–åˆ°è´¦æˆ·', 'error');
                }
                
            } catch (error) {
                log(\`âŒ è¿æ¥å¤±è´¥: \${error.message}\`, 'error');
                
                if (error.message.includes('already pending')) {
                    log('ğŸš¨ ä»æœ‰å¾…å¤„ç†è¯·æ±‚ï¼è¯·æŒ‰ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š', 'warning');
                    log('1. ç‚¹å‡»æµè§ˆå™¨å³ä¸Šè§’MetaMaskå›¾æ ‡', 'warning');
                    log('2. å–æ¶ˆæˆ–å¤„ç†å¾…å¤„ç†çš„è¯·æ±‚', 'warning');
                    log('3. ç‚¹å‡»"å¼ºåˆ¶åˆ·æ–°é¡µé¢"æŒ‰é’®', 'warning');
                }
            }
        }
        
        // æµ‹è¯•äº¤æ˜“
        async function testTransaction() {
            if (!account) {
                log('âŒ è¯·å…ˆè¿æ¥è´¦æˆ·', 'error');
                return;
            }
            
            log('=== å¼€å§‹äº¤æ˜“æµ‹è¯• ===', 'info');
            
            try {
                log('ğŸ“‹ å‡†å¤‡äº¤æ˜“å‚æ•°...', 'info');
                const txHash = await window.ethereum.request({
                    method: 'eth_sendTransaction',
                    params: [{
                        from: account,
                        to: '0x742d35Cc6635C0532925a3b8D06080f0Ec0BAff5',
                        value: '0x2386F26FC10000', // 0.01 ETH
                        gas: '0x5208'
                    }]
                });
                
                log(\`ğŸ‰ äº¤æ˜“æäº¤æˆåŠŸ! å“ˆå¸Œ: \${txHash}\`, 'success');
                
            } catch (error) {
                log(\`âŒ äº¤æ˜“å¤±è´¥: \${error.message}\`, 'error');
                
                if (error.code === 4001) {
                    log('ğŸ‘† ç”¨æˆ·å–æ¶ˆäº†äº¤æ˜“', 'warning');
                } else {
                    log(\`è¯¦ç»†é”™è¯¯: \${JSON.stringify(error)}\`, 'error');
                }
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶çš„æç¤º
        window.addEventListener('load', () => {
            log('ğŸ”§ MetaMaskçŠ¶æ€æ¸…ç†å·¥å…·å·²åŠ è½½', 'info');
            log('ğŸ’¡ å¦‚æœé‡åˆ°"already pending"é”™è¯¯ï¼Œè¯·å…ˆå¤„ç†MetaMaskä¸­çš„å¾…å¤„ç†è¯·æ±‚', 'warning');
        });
    </script>
</body>
</html>