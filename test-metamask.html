<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MetaMaskè¿æ¥æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }
        .status-box {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #00ff00;
        }
        .error-box {
            background: rgba(255, 0, 0, 0.2);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #ff0000;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        pre {
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 10px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” MetaMaskè¿æ¥è¯Šæ–­å·¥å…·</h1>
        
        <div id="statusDisplay" class="status-box">
            <h3>æ£€æµ‹çŠ¶æ€ï¼š</h3>
            <div id="statusText">æ­£åœ¨æ£€æµ‹...</div>
        </div>

        <div class="buttons">
            <button onclick="detectMetaMask()">ğŸ” æ£€æµ‹MetaMask</button>
            <button onclick="connectWallet()" id="connectBtn" disabled>ğŸ”— è¿æ¥é’±åŒ…</button>
            <button onclick="sendTestTransaction()" id="sendBtn" disabled>ğŸ’¸ å‘é€æµ‹è¯•äº¤æ˜“</button>
            <button onclick="clearLogs()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
        </div>

        <div id="errorDisplay" class="error-box" style="display: none;">
            <h3>âŒ é”™è¯¯ä¿¡æ¯ï¼š</h3>
            <div id="errorText"></div>
        </div>

        <div class="status-box">
            <h3>ğŸ“‹ è¯¦ç»†æ—¥å¿—ï¼š</h3>
            <pre id="logOutput">ç­‰å¾…æ“ä½œ...</pre>
        </div>

        <div class="status-box">
            <h3>ğŸ’¡ è§£å†³æ–¹æ¡ˆï¼š</h3>
            <ul>
                <li>ç¡®ä¿å·²å®‰è£…MetaMaskæµè§ˆå™¨æ‰©å±•</li>
                <li>åˆ·æ–°é¡µé¢å¹¶é‡è¯•</li>
                <li>æ£€æŸ¥MetaMaskæ˜¯å¦è¢«å…¶ä»–ç½‘ç«™é˜»æ­¢</li>
                <li>å°è¯•åœ¨æ— ç—•æ¨¡å¼ä¸‹æµ‹è¯•</li>
                <li>æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°é”™è¯¯ä¿¡æ¯</li>
            </ul>
        </div>
    </div>

    <script>
        let account = null;
        let logs = [];

        function addLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            logs.push(`[${timestamp}] ${message}`);
            document.getElementById('logOutput').textContent = logs.join('\n');
            console.log(message);
        }

        function showError(message) {
            document.getElementById('errorDisplay').style.display = 'block';
            document.getElementById('errorText').textContent = message;
            addLog(`âŒ é”™è¯¯: ${message}`);
        }

        function hideError() {
            document.getElementById('errorDisplay').style.display = 'none';
        }

        function clearLogs() {
            logs = [];
            document.getElementById('logOutput').textContent = 'æ—¥å¿—å·²æ¸…ç©º';
            hideError();
        }

        async function detectMetaMask() {
            addLog('ğŸ” å¼€å§‹æ£€æµ‹MetaMask...');
            hideError();
            
            // æ£€æŸ¥åŸºæœ¬å˜é‡
            addLog(`window.ethereum å­˜åœ¨: ${!!window.ethereum}`);
            addLog(`window.web3 å­˜åœ¨: ${!!window.web3}`);
            
            if (!window.ethereum) {
                showError('MetaMaskæœªå®‰è£…æˆ–æœªå¯ç”¨');
                document.getElementById('statusText').innerHTML = `
                    âŒ MetaMaskæœªæ£€æµ‹åˆ°<br>
                    <a href="https://metamask.io/download/" target="_blank" style="color: #00ff00;">ç‚¹å‡»ä¸‹è½½MetaMask</a>
                `;
                return;
            }

            // æ£€æµ‹MetaMaskè¯¦ç»†ä¿¡æ¯
            addLog(`MetaMask isMetaMask: ${window.ethereum.isMetaMask}`);
            addLog(`MetaMask chainId: ${window.ethereum.chainId}`);
            addLog(`MetaMask selectedAddress: ${window.ethereum.selectedAddress}`);

            // æ£€æŸ¥æƒé™
            try {
                const permissions = await window.ethereum.request({
                    method: 'wallet_getPermissions'
                });
                addLog(`æƒé™æ•°é‡: ${permissions.length}`);
                
                const accounts = await window.ethereum.request({
                    method: 'eth_accounts'
                });
                addLog(`å·²è¿æ¥è´¦æˆ·æ•°: ${accounts.length}`);
                
                if (accounts.length > 0) {
                    account = accounts[0];
                    addLog(`å½“å‰è´¦æˆ·: ${account}`);
                    document.getElementById('statusText').innerHTML = `
                        âœ… MetaMaskå·²å®‰è£…å¹¶è¿æ¥<br>
                        è´¦æˆ·: ${account.slice(0,6)}...${account.slice(-4)}
                    `;
                    document.getElementById('connectBtn').textContent = 'âœ… å·²è¿æ¥';
                    document.getElementById('sendBtn').disabled = false;
                } else {
                    document.getElementById('statusText').innerHTML = `
                        âœ… MetaMaskå·²å®‰è£…<br>
                        âš ï¸ æœªè¿æ¥è´¦æˆ·
                    `;
                    document.getElementById('connectBtn').disabled = false;
                }
                
            } catch (error) {
                addLog(`æƒé™æ£€æŸ¥å¤±è´¥: ${error.message}`);
                document.getElementById('connectBtn').disabled = false;
            }
        }

        async function connectWallet() {
            addLog('ğŸ”— å¼€å§‹è¿æ¥é’±åŒ…...');
            hideError();

            if (!window.ethereum) {
                showError('MetaMaskæœªå®‰è£…');
                return;
            }

            const connectBtn = document.getElementById('connectBtn');
            const originalText = connectBtn.textContent;
            
            try {
                connectBtn.textContent = 'è¿æ¥ä¸­...';
                connectBtn.disabled = true;

                addLog('å‘é€è¿æ¥è¯·æ±‚...');
                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });

                addLog(`æ”¶åˆ°è´¦æˆ·: ${JSON.stringify(accounts)}`);

                if (accounts && accounts.length > 0) {
                    account = accounts[0];
                    addLog(`âœ… è¿æ¥æˆåŠŸ: ${account}`);
                    
                    document.getElementById('statusText').innerHTML = `
                        âœ… é’±åŒ…è¿æ¥æˆåŠŸ<br>
                        è´¦æˆ·: ${account.slice(0,6)}...${account.slice(-4)}
                    `;
                    
                    connectBtn.textContent = 'âœ… å·²è¿æ¥';
                    document.getElementById('sendBtn').disabled = false;

                    // è·å–ç½‘ç»œä¿¡æ¯
                    try {
                        const chainId = await window.ethereum.request({
                            method: 'eth_chainId'
                        });
                        addLog(`ç½‘ç»œé“¾ID: ${chainId} (${parseInt(chainId, 16)})`);
                    } catch (chainError) {
                        addLog(`è·å–é“¾IDå¤±è´¥: ${chainError.message}`);
                    }

                } else {
                    throw new Error('æœªè¿”å›ä»»ä½•è´¦æˆ·');
                }

            } catch (error) {
                addLog(`âŒ è¿æ¥å¤±è´¥: ${error.message}`);
                addLog(`é”™è¯¯ä»£ç : ${error.code}`);
                addLog(`å®Œæ•´é”™è¯¯: ${JSON.stringify(error, null, 2)}`);
                
                let errorMessage = 'è¿æ¥å¤±è´¥';
                
                if (error.code === 4001) {
                    errorMessage = 'ç”¨æˆ·æ‹’ç»äº†è¿æ¥è¯·æ±‚';
                } else if (error.code === -32002) {
                    errorMessage = 'MetaMaskè¿æ¥è¯·æ±‚å¾…å¤„ç†ï¼Œè¯·æ£€æŸ¥MetaMaskå¼¹çª—';
                } else if (error.code === -32603) {
                    errorMessage = 'å†…éƒ¨é”™è¯¯ï¼Œè¯·é‡è¯•';
                } else {
                    errorMessage = `è¿æ¥å¤±è´¥: ${error.message}`;
                }
                
                showError(errorMessage);
                connectBtn.textContent = originalText;
                connectBtn.disabled = false;
            }
        }

        async function sendTestTransaction() {
            addLog('ğŸ’¸ å‡†å¤‡å‘é€æµ‹è¯•äº¤æ˜“...');
            hideError();

            if (!account) {
                showError('è¯·å…ˆè¿æ¥é’±åŒ…');
                return;
            }

            const sendBtn = document.getElementById('sendBtn');
            const originalText = sendBtn.textContent;

            try {
                sendBtn.textContent = 'å‘é€ä¸­...';
                sendBtn.disabled = true;

                addLog('å‘é€äº¤æ˜“è¯·æ±‚åˆ°MetaMask...');
                
                const txParams = {
                    from: account,
                    to: '0x742d35Cc6bf08Ca904C1b3D02d97bCd2de0a04C8',
                    value: '0x16345785d8a0000', // 0.1 ETH in wei (hex)
                    gas: '0x5208', // 21000 gas
                };

                addLog(`äº¤æ˜“å‚æ•°: ${JSON.stringify(txParams, null, 2)}`);

                const txHash = await window.ethereum.request({
                    method: 'eth_sendTransaction',
                    params: [txParams],
                });

                addLog(`âœ… äº¤æ˜“å‘é€æˆåŠŸ!`);
                addLog(`äº¤æ˜“å“ˆå¸Œ: ${txHash}`);
                
                document.getElementById('statusText').innerHTML = `
                    âœ… æµ‹è¯•äº¤æ˜“æˆåŠŸ<br>
                    å“ˆå¸Œ: ${txHash.slice(0,10)}...${txHash.slice(-8)}
                `;

            } catch (error) {
                addLog(`âŒ äº¤æ˜“å¤±è´¥: ${error.message}`);
                addLog(`é”™è¯¯ä»£ç : ${error.code}`);
                addLog(`å®Œæ•´é”™è¯¯: ${JSON.stringify(error, null, 2)}`);
                
                let errorMessage = 'äº¤æ˜“å¤±è´¥';
                
                if (error.code === 4001) {
                    errorMessage = 'ç”¨æˆ·å–æ¶ˆäº†äº¤æ˜“';
                } else if (error.code === -32603) {
                    errorMessage = 'äº¤æ˜“è¢«æ‹’ç»ï¼Œå¯èƒ½æ˜¯ä½™é¢ä¸è¶³';
                } else if (error.code === -32000) {
                    errorMessage = 'ä½™é¢ä¸è¶³';
                } else {
                    errorMessage = `äº¤æ˜“å¤±è´¥: ${error.message}`;
                }
                
                showError(errorMessage);
                
            } finally {
                sendBtn.textContent = originalText;
                sendBtn.disabled = false;
            }
        }

        // ç›‘å¬MetaMaskäº‹ä»¶
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', function(accounts) {
                addLog(`è´¦æˆ·å˜æ›´: ${JSON.stringify(accounts)}`);
                if (accounts.length > 0) {
                    account = accounts[0];
                } else {
                    account = null;
                    document.getElementById('connectBtn').textContent = 'ğŸ”— è¿æ¥é’±åŒ…';
                    document.getElementById('connectBtn').disabled = false;
                    document.getElementById('sendBtn').disabled = true;
                }
            });

            window.ethereum.on('chainChanged', function(chainId) {
                addLog(`ç½‘ç»œå˜æ›´: ${chainId} (${parseInt(chainId, 16)})`);
            });
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æµ‹
        window.addEventListener('load', () => {
            addLog('ğŸ“± é¡µé¢åŠ è½½å®Œæˆ');
            setTimeout(detectMetaMask, 1000);
        });
    </script>
</body>
</html>