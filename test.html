<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Simple MetaMask Test</title>
</head>
<body style="font-family:Arial; padding:30px; background:#f5f5f5;">
    <h1 style="color:#333;">MetaMask Connection Test</h1>
    
    <div style="background:white; padding:20px; border-radius:8px; margin:20px 0;">
        <h2>Status</h2>
        <div id="status">Not connected</div>
        <div id="account"></div>
    </div>
    
    <button onclick="connect()" style="background:#007bff; color:white; border:none; padding:15px 30px; border-radius:5px; font-size:16px; cursor:pointer; margin:10px;">
        Connect MetaMask
    </button>
    
    <button onclick="sendTx()" style="background:#28a745; color:white; border:none; padding:15px 30px; border-radius:5px; font-size:16px; cursor:pointer; margin:10px;">
        Send Test Transaction
    </button>
    
    <button onclick="reload()" style="background:#dc3545; color:white; border:none; padding:15px 30px; border-radius:5px; font-size:16px; cursor:pointer; margin:10px;">
        Force Reload
    </button>
    
    <div style="background:#000; color:#00ff00; padding:20px; border-radius:8px; margin:20px 0; height:300px; overflow-y:auto; font-family:monospace;" id="log">
        Ready...
    </div>

    <script>
        let userAccount = null;
        
        function addLog(msg) {
            const time = new Date().toLocaleTimeString();
            const logEl = document.getElementById('log');
            logEl.innerHTML += '<div>[' + time + '] ' + msg + '</div>';
            logEl.scrollTop = logEl.scrollHeight;
            console.log(msg);
        }
        
        function updateStatus() {
            document.getElementById('status').textContent = userAccount ? 'Connected' : 'Not connected';
            document.getElementById('account').textContent = userAccount || '';
        }
        
        async function connect() {
            addLog('=== Starting Connection ===');
            
            if (!window.ethereum) {
                addLog('ERROR: MetaMask not found!');
                alert('Please install MetaMask: https://metamask.io');
                return;
            }
            
            addLog('MetaMask detected');
            
            try {
                addLog('Requesting account access...');
                addLog('IMPORTANT: Look for MetaMask popup!');
                
                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });
                
                if (accounts && accounts.length > 0) {
                    userAccount = accounts[0];
                    addLog('SUCCESS: Connected to ' + userAccount);
                    updateStatus();
                } else {
                    addLog('ERROR: No accounts returned');
                }
                
            } catch (error) {
                addLog('ERROR: ' + error.message);
                
                if (error.message.includes('already pending')) {
                    addLog('SOLUTION NEEDED:');
                    addLog('1. Click MetaMask icon in browser');
                    addLog('2. Cancel any pending requests');  
                    addLog('3. Click Force Reload button');
                    alert('MetaMask has pending request!\n\n1. Click MetaMask icon\n2. Cancel pending request\n3. Click Force Reload');
                }
            }
        }
        
        async function sendTx() {
            if (!userAccount) {
                addLog('ERROR: Please connect first');
                return;
            }
            
            addLog('=== Sending Transaction ===');
            
            try {
                addLog('Preparing transaction...');
                
                const txHash = await window.ethereum.request({
                    method: 'eth_sendTransaction',
                    params: [{
                        from: userAccount,
                        to: '0x742d35Cc6635C0532925a3b8D06080f0Ec0BAff5',
                        value: '0x2386F26FC10000',
                        gas: '0x5208'
                    }]
                });
                
                addLog('SUCCESS: Transaction sent! Hash: ' + txHash);
                
            } catch (error) {
                addLog('ERROR: Transaction failed - ' + error.message);
                if (error.code === 4001) {
                    addLog('User cancelled transaction');
                }
            }
        }
        
        function reload() {
            addLog('Force reloading page...');
            setTimeout(() => {
                window.location.reload(true);
            }, 1000);
        }
        
        // Check on load
        window.onload = async function() {
            addLog('Page loaded');
            
            if (window.ethereum) {
                addLog('MetaMask found');
                try {
                    const accounts = await window.ethereum.request({method: 'eth_accounts'});
                    if (accounts.length > 0) {
                        userAccount = accounts[0];
                        addLog('Already connected: ' + userAccount);
                        updateStatus();
                    }
                } catch (e) {
                    addLog('Could not check existing accounts');
                }
            } else {
                addLog('MetaMask NOT found - please install');
            }
        };
    </script>
</body>
</html>